function plane(t,i){return function(o,s){var e=o*t,n=s*i,r=0;return new THREE.Vector3(e,n,r)}}function Particle(t,i,o,s){this.position=clothFunction(t,i),this.previous=clothFunction(t,i),this.original=clothFunction(t,i),this.a=new THREE.Vector3(0,0,0),this.mass=s,this.invMass=1/s,this.tmp=new THREE.Vector3,this.tmp2=new THREE.Vector3}function satisifyConstrains(t,i,o){diff.sub(i.position,t.position);var s=diff.length();if(0!=s){var e=diff.multiplyScalar(1-o/s),n=e.multiplyScalar(.5);t.position.addSelf(n),i.position.subSelf(n)}}function Cloth(t,i){function o(i,o){return i+o*(t+1)}t=t||10,i=i||10,this.w=t,this.h=i;var s=[],e=[],n,r;for(r=0;i>=r;r++)for(n=0;t>=n;n++)s.push(new Particle(n/t,r/i,0,MASS));for(r=0;i>r;r++)for(n=0;t>n;n++)e.push([s[o(n,r)],s[o(n,r+1)],restDistance]),e.push([s[o(n,r)],s[o(n+1,r)],restDistance]);for(n=t,r=0;i>r;r++)e.push([s[o(n,r)],s[o(n,r+1)],restDistance]);for(r=i,n=0;t>n;n++)e.push([s[o(n,r)],s[o(n+1,r)],restDistance]);var a=Math.sqrt(restDistance*restDistance*2);for(r=0;i>r;r++)for(n=0;t>n;n++)e.push([s[o(n,r)],s[o(n+1,r+1)],a]),e.push([s[o(n+1,r)],s[o(n,r+1)],a]);this.particles=s,this.constrains=e,this.index=o}function simulate(t){if(!lastTime)return void(lastTime=t);var i,o,s,e,n,r,a;if(wind){var l,c=clothGeometry.faces,p;for(s=cloth.particles,i=0,o=c.length;o>i;i++)l=c[i],p=l.normal,tmpForce.copy(p).normalize().multiplyScalar(p.dot(windForce)),s[l.a].addForce(tmpForce),s[l.b].addForce(tmpForce),s[l.c].addForce(tmpForce)}for(s=cloth.particles,i=0,o=s.length;o>i;i++)e=s[i],e.addForce(gravity),e.integrate(TIMESTEP_SQ);for(r=cloth.constrains,o=r.length,i=0;o>i;i++)a=r[i],satisifyConstrains(a[0],a[1],a[2]);if(ballPosition.z=90*-Math.sin(Date.now()/300),ballPosition.x=70*Math.cos(Date.now()/200),sphere.visible)for(s=cloth.particles,i=0,o=s.length;o>i;i++)e=s[i],pos=e.position,diff.sub(pos,ballPosition),diff.length()<ballSize&&(diff.normalize().multiplyScalar(ballSize),pos.copy(ballPosition).addSelf(diff));for(i=0,o=pins.length;o>i;i++){var h=pins[i],f=s[h];f.position.copy(f.original),f.previous.copy(f.original)}}var DAMPING=.03,DRAG=1-DAMPING,MASS=.2,restDistance=30,xSegs=30,ySegs=20,clothFunction=plane(restDistance*xSegs,restDistance*ySegs),cloth=new Cloth(xSegs,ySegs),GRAVITY=280,gravity=new THREE.Vector3(0,-GRAVITY,0).multiplyScalar(MASS),TIMESTEP=18/7e3,TIMESTEP_SQ=TIMESTEP*TIMESTEP,pins=[],wind=!0,windStrength=2,windForce=new THREE.Vector3(0,0,0),ballPosition=new THREE.Vector3(0,-45,0),ballSize=60,tmpForce=new THREE.Vector3,lastTime;Particle.prototype.addForce=function(t){this.a.addSelf(this.tmp2.copy(t).multiplyScalar(this.invMass))},Particle.prototype.integrate=function(t){var i=this.tmp.sub(this.position,this.previous);i.multiplyScalar(DRAG).addSelf(this.position),i.addSelf(this.a.multiplyScalar(t)),this.tmp=this.previous,this.previous=this.position,this.position=i,this.a.set(0,0,0)};var diff=new THREE.Vector3;